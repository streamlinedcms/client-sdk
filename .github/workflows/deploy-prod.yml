name: Deploy Production

on:
    push:
        branches: [master]

jobs:
    get-pr-info:
        runs-on: ubuntu-latest
        outputs:
            should_deploy: ${{ steps.lookup.outputs.should_deploy }}
            bump_type: ${{ steps.lookup.outputs.bump_type }}
            head_ref: ${{ steps.lookup.outputs.head_ref }}
            pr_number: ${{ steps.lookup.outputs.pr_number }}

        steps:
            - name: Lookup merged PR
              id: lookup
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  # Check if this is an automated commit (e.g., version bump)
                  AUTHOR=$(gh api "/repos/${{ github.repository }}/commits/${{ github.sha }}" --jq '.author.login')
                  if [ "$AUTHOR" = "github-actions[bot]" ]; then
                      echo "Automated commit by $AUTHOR, skipping deploy"
                      echo "should_deploy=false" >> $GITHUB_OUTPUT
                      exit 0
                  fi

                  # Find PR associated with this commit
                  PR_DATA=$(gh api "/repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" --jq '.[0]' 2>/dev/null || echo "")

                  if [ -z "$PR_DATA" ] || [ "$PR_DATA" = "null" ]; then
                      echo "::error::No PR found for commit ${{ github.sha }}"
                      exit 1
                  fi

                  PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
                  HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
                  echo "Found PR #$PR_NUMBER from branch $HEAD_REF"

                  # Get labels from PR
                  LABELS=$(echo "$PR_DATA" | jq -r '.labels[].name')
                  echo "Labels: $LABELS"

                  # Determine bump type from labels
                  if echo "$LABELS" | grep -q 'release:major'; then
                      BUMP_TYPE="major"
                  elif echo "$LABELS" | grep -q 'release:minor'; then
                      BUMP_TYPE="minor"
                  elif echo "$LABELS" | grep -q 'release:patch'; then
                      BUMP_TYPE="patch"
                  else
                      echo "::error::No release label found on PR #$PR_NUMBER"
                      exit 1
                  fi

                  echo "Bump type: $BUMP_TYPE"
                  echo "should_deploy=true" >> $GITHUB_OUTPUT
                  echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
                  echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
                  echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

    deploy:
        needs: get-pr-info
        if: needs.get-pr-info.outputs.should_deploy == 'true'
        runs-on: ubuntu-latest
        environment: production

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.RELEASE_PAT }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Bump version
              id: version
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  BUMP_TYPE="${{ needs.get-pr-info.outputs.bump_type }}"
                  HEAD_REF="${{ needs.get-pr-info.outputs.head_ref }}"
                  CURRENT_VERSION=$(node -p "require('./package.json').version")

                  echo "Source branch: $HEAD_REF"
                  echo "Current version: $CURRENT_VERSION"
                  echo "Bump type: $BUMP_TYPE"

                  # Check if this is a release branch with prerelease suffix
                  if [[ "$HEAD_REF" =~ ^release/([0-9]+\.[0-9]+\.[0-9]+)(-([a-z]+))?$ ]]; then
                      TARGET_BASE="${BASH_REMATCH[1]}"
                      PRERELEASE_SUFFIX="${BASH_REMATCH[3]}"

                      if [ -n "$PRERELEASE_SUFFIX" ]; then
                          echo "Prerelease branch detected: $PRERELEASE_SUFFIX"

                          # Check if already in this prerelease series
                          if [[ "$CURRENT_VERSION" == "$TARGET_BASE-$PRERELEASE_SUFFIX"* ]]; then
                              echo "Incrementing existing $PRERELEASE_SUFFIX series"
                              npm version prerelease -m "chore: release v%s"
                          else
                              echo "Starting new $PRERELEASE_SUFFIX series"
                              npm version "pre$BUMP_TYPE" --preid="$PRERELEASE_SUFFIX" -m "chore: release v%s"
                          fi
                      else
                          echo "Stable release branch"
                          npm version "$BUMP_TYPE" -m "chore: release v%s"
                      fi
                  else
                      echo "Regular branch (not release/*)"
                      npm version "$BUMP_TYPE" -m "chore: release v%s"
                  fi

                  NEW_VERSION=$(node -p "require('./package.json').version")
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION"

            - name: Push version commit and tag
              run: git push --follow-tags

            - name: Create .env for build
              run: |
                  echo "SDK_API_URL=${{ vars.SDK_API_URL }}" >> .env
                  echo "SDK_APP_URL=${{ vars.SDK_APP_URL }}" >> .env
                  echo "R2_BUCKET_PRODUCTION=${{ vars.R2_BUCKET_PRODUCTION }}" >> .env
                  echo "KV_NAMESPACE_PRODUCTION=${{ vars.KV_NAMESPACE_PRODUCTION }}" >> .env

            - name: Build
              run: npm run build

            - name: Upload to CDN
              run: node scripts/cdn-upload.js production --ci --skip-build
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Publish version
              run: node scripts/cdn-publish.js production --ci
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

    sync-develop:
        needs: [get-pr-info, deploy]
        if: startsWith(needs.get-pr-info.outputs.head_ref, 'release/')
        runs-on: ubuntu-latest
        environment: production

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.RELEASE_PAT }}

            - name: Sync master to develop
              env:
                  GH_TOKEN: ${{ secrets.RELEASE_PAT }}
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git fetch origin master develop
                  git checkout develop

                  if git merge origin/master --no-edit; then
                      echo "Merge successful, pushing to develop"
                      git push
                  else
                      echo "Merge conflict detected, creating PR for manual resolution"
                      git merge --abort
                      gh pr create --base develop --head master \
                          --title "Sync master to develop" \
                          --body "Auto-generated PR to sync release changes back to develop. Manual conflict resolution required."
                  fi

            - name: Delete release branch
              env:
                  GH_TOKEN: ${{ secrets.RELEASE_PAT }}
              run: |
                  HEAD_REF="${{ needs.get-pr-info.outputs.head_ref }}"
                  echo "Deleting branch: $HEAD_REF"
                  git push origin --delete "$HEAD_REF"
