name: Deploy Production

on:
    pull_request:
        branches: [master]
        types: [closed]

jobs:
    check-label:
        if: github.event.pull_request.merged == true
        uses: ./.github/workflows/check-release-label.yml
        with:
            labels: ${{ toJson(github.event.pull_request.labels.*.name) }}
            require: true

    deploy:
        needs: check-label
        runs-on: ubuntu-latest
        environment: production

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Bump version
              id: version
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  npm version ${{ needs.check-label.outputs.type }} -m "chore: release v%s"
                  NEW_VERSION=$(node -p "require('./package.json').version")
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "New version: $NEW_VERSION"

            - name: Push version commit and tag
              run: git push --follow-tags

            - name: Create .env for build
              run: |
                  echo "SDK_API_URL=${{ vars.SDK_API_URL }}" >> .env
                  echo "SDK_APP_URL=${{ vars.SDK_APP_URL }}" >> .env
                  echo "R2_BUCKET_PRODUCTION=${{ vars.R2_BUCKET_PRODUCTION }}" >> .env
                  echo "KV_NAMESPACE_PRODUCTION=${{ vars.KV_NAMESPACE_PRODUCTION }}" >> .env

            - name: Build
              run: npm run build

            - name: Upload to CDN
              run: node scripts/cdn-upload.js production --ci
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Publish version
              run: node scripts/cdn-publish.js production --ci
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
