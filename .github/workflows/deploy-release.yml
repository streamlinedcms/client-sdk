name: Deploy Release

on:
    push:
        branches:
            - "release/*"

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: production

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Generate release version
              id: version
              run: |
                  # Extract version from branch name (release/1.0.0-beta â†’ 1.0.0-beta)
                  BRANCH_VERSION=${GITHUB_REF_NAME#release/}

                  # Check if version has a prerelease suffix
                  if [[ "$BRANCH_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)(-(.+))?$ ]]; then
                    BASE_VERSION="${BASH_REMATCH[1]}"
                    SUFFIX="${BASH_REMATCH[3]}"

                    # If no suffix, default to rc
                    if [ -z "$SUFFIX" ]; then
                      SUFFIX="rc"
                    fi
                  else
                    echo "::error::Invalid branch name format: $BRANCH_VERSION"
                    exit 1
                  fi

                  TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
                  SHORT_SHA=$(git rev-parse --short HEAD)
                  RELEASE_VERSION="${BASE_VERSION}-${SUFFIX}.${TIMESTAMP}.${SHORT_SHA}"

                  echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
                  echo "Generated version: $RELEASE_VERSION"

            - name: Create .env for build
              run: |
                  echo "SDK_API_URL=${{ vars.SDK_API_URL }}" >> .env
                  echo "SDK_APP_URL=${{ vars.SDK_APP_URL }}" >> .env
                  echo "R2_BUCKET_PRODUCTION=${{ vars.R2_BUCKET_PRODUCTION }}" >> .env
                  echo "KV_NAMESPACE_PRODUCTION=${{ vars.KV_NAMESPACE_PRODUCTION }}" >> .env

            - name: Build
              run: npm run build
              env:
                  SDK_VERSION: ${{ steps.version.outputs.version }}

            - name: Upload to CDN
              run: node scripts/cdn-upload.js production --ci --skip-build --version=${{ steps.version.outputs.version }}
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Publish version (no aliases)
              run: node scripts/cdn-publish.js production --ci --version=${{ steps.version.outputs.version }} --no-alias
              env:
                  CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
