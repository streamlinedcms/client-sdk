name: Deploy Staging

on:
    push:
        branches: [develop]

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: staging

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Create .env for build
              run: |
                  echo "SDK_API_URL=${{ vars.SDK_API_URL }}" >> .env
                  echo "SDK_APP_URL=${{ vars.SDK_APP_URL }}" >> .env
                  echo "R2_BUCKET_STAGING=${{ vars.R2_BUCKET_STAGING }}" >> .env
                  echo "KV_NAMESPACE_STAGING=${{ vars.KV_NAMESPACE_STAGING }}" >> .env

            - name: Build
              run: npm run build

            - name: Upload to CDN
              run: node scripts/cdn-upload.js staging --yes
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

            - name: Publish version
              run: node scripts/cdn-publish.js staging --yes
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
